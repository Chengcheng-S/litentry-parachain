name: Simulate runtime upgrade

on:
  release:
    types: [released]

jobs:
  check runtime version:
    run-on: ubuntu-latest
    strategy:
      matrix:
        chain:
          # litmus is not supported, as sudo was removed
          # TODO: add runtime upgrade via governance
          - litentry
          - rococo
    if: contains(github.event.release.body, '${{ matrix.chain }}-parachain-runtime.compact.compressed.wasm')
    steps:
    - name: check runtime version
  #         get rococo && litentry runtime version by rpc call such as fork-off-substrate or other way && check if new ?
  #         if not exit yes  continue.
    run: |
          echo "start check runtime version"
          ./scripts/check-runtime-version

  simulate-runtime-upgrade:
    runs-on: ubuntu-latest
    needs: check runtime version
    strategy:
      matrix:
        chain:
          # litmus is not supported, as sudo was removed
          # TODO: add runtime upgrade via governance
          - litentry
          - rococo
    steps:
      - name: Checkout codes on ${{ github.ref }}
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Fork ${{ matrix.chain }} and launch parachain
        timeout-minutes: 10
        run: |
          ./scripts/fork-parachain-and-launch.sh ${{ matrix.chain }}

      - name: Test runtime upgrade
        timeout-minutes: 10
        run: |
          ./scripts/runtime-upgrade.sh https://github.com/litentry/litentry-parachain/releases/download/${{ github.event.release.tag_name }}/${{ matrix.chain }}-parachain-runtime.compact.compressed.wasm
